!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).comtab=e(t._)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=e(t);function a(...t){return s.default.merge.apply(null,t)}function n(t){return s.default.cloneDeep(t)}function i(t){return void 0===t}function l(t){var e={};if(t)for(var s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||(e[s]={value:t[s],writable:!0,configurable:!0,enumerable:!0});return Object.create(null,e)}function o(t=""){var e,s=16,a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=[];for(s=s||a.length,e=0;e<32;e++)n[e]=a[0|Math.random()*s];return t+n.join("")}function r(t,e="div"){return $(`<${e} class="${t}">`)}class h{constructor(t,e=!0){this.type=t+"Event",this._bubble=e,this._isBubble=!1}isType(t){return this.getTypeName()===t}getTypeName(){return t=this.type,e=0,s=-5,t.substring(e,s<0?t.length+s:s);var t,e,s}stopPropagation(){this._bubble=!1}isPropagation(){return this._bubble}progagation(){this._isBubble=!0}isBubble(){return this._isBubble}}class d extends h{constructor(t){super("Model",t)}}class p{constructor(t,e){this.link(t,e)}dispatch(...t){const e=t[0],s=this[`dispatch${e.getTypeName()}`];Reflect.apply(s,this,t),this.propagation(e,t.slice(1))}link(t,e){t.bind(this,e),e.bind(this,t),this._model=t,this._view=e}setParent(t){this._parent=t}getParent(){return this._parent}propagation(t,e){this._parent&&t.isPropagation()&&(t.progagation(),Reflect.apply(this._parent.dispatch,this._parent,[t,...e]))}}class _ extends p{constructor(t,e,s){super(t,e),this.host=s}dispatchModel(t,e,s){"deactivateTab"!==e?"activateTab"!==e||this._parent?"toggleTabHandleEvent"===e&&this._view.toggleTabHandleEvent(s):this._view.activate():this._view.deactivate()}dispatchView(t,...e){throw new Error("Method not implemented.")}}function c(t,e,s){Reflect.apply(t,e,s)}function b(t,e){this._controller=t,this instanceof v?this.linkView(e):this.linkModel(e)}class v{constructor(){this._data=Object.create(null),this.bind=b}linkView(t){this._view=t}}v.prototype.notify=function(...t){c(this._controller.dispatch,this._controller,t)};class u extends v{constructor(t,e){super(),this._state={btnText:"btn",content:"<p>This is content.<p>",actived:!1,_tabHandleEnabled:!1},a(this._state,t),this.host=e}toggleTabHandleEvent(t){this._state._tabHandleEnabled!==t&&(this._state._tabHandleEnabled=t,this.notify(new d(!1),"toggleTabHandleEvent",t))}activate(t=new d){this._state.actived||(this._state.actived=!0,this.notify(t,"activateTab",{targetModel:this}))}deactivate(t=new d){this._state.actived=!1,this.notify(t,"deactivateTab")}getState(){return this._state}}var g=function(t){var e=t+"-stage",s=t+"-panel",a=s+"-dropready",n=s+"-group",i=n+"_column",o=t+"-tab",r=o+"_header",h=t+"-absorb",d=h+"-vertical",p=h+"-horizontal",_=l({PANE:s,PANE_HANDLE:s+"_handle",PANE_GROUP:n,TAB:o,TAB_HEADER:r,TAB_CONTENT:o+"_content",TAB_BTN:o+"_btn",ABSORB:h,CONTAINER:t+"-container"});for(var c in _)_[c+"_ACTIVE"]=_[c]+"-active";return _.ABSORB_VERTICAL=d,_.ABSORB_HORIZONTAL=p,["top","right","left","bottom"].forEach((function(t){_["ABSORB_"+t.toUpperCase()]=h+"_"+t})),_.PANE_DROP_READY=a,_.PANE_GROUP_COLUMN=i,_.TAB_HEADER_DROP=r+"_droppable",_.STAGE=e,_}("comtab");class w{constructor(){this.bind=b}linkModel(t){this._model=t}}w.prototype.notify=function(...t){c(this._controller.dispatch,this._controller,t)};var E=new class{constructor(t){this._value=t,this._initValue=n(t)}set value(t){this._value=t}get value(){return this._value}reset(){this._value=this._initValue}}({type:"init"});class T extends w{constructor(t){super(),this.events={},this.host=t}toggleTabHandleEvent(t){t?this._$btn.addClass(g.PANE_HANDLE):this._$btn.removeClass(g.PANE_HANDLE)}create(t){t=t||this._model.getState(),this._$btn=r(g.TAB_BTN).text(t.btnText),this._$content=$(t.content).addClass(g.TAB_CONTENT),t.actived&&this.activate(),this.bindEvents()}bindEvents(){this._$btn.on("click",(()=>this._model.activate())),this.events.tabSplit=this._$btn.draggable({delay:200,helper:()=>{const t=S.copyPanelByTabs(this.host);return E.value.panel=t,E.value.tab=this.host,E.value.type="tmpPanelFromTabDrag",t._view.getElements().wrapper}})}toggleTabSplitEvent(t){t=i(t)?t:this.events.tabSplit.draggable("option","disabled"),this.events.tabSplit.draggable(t?"enable":"disable")}activate(){this._$content.addClass(g.TAB_CONTENT_ACTIVE),this._$btn.addClass(g.TAB_BTN_ACTIVE)}deactivate(){this._$content.removeClass(g.TAB_CONTENT_ACTIVE),this._$btn.removeClass(g.TAB_BTN_ACTIVE)}getElements(){return{btn:this._$btn,content:this._$content}}remove(){this._$btn.remove(),this._$content.remove()}}class f{constructor(t){this._model=new u(t,this),this._view=new T(this),this._controller=new _(this._model,this._view,this),this._init()}_init(){const t=this._model.getState();this._view.create(t)}getParent(){return this._controller.getParent().host}static copy(t){return new f(t._model.getState())}}class m extends p{constructor(t,e,s){super(t,e),this.host=s}dispatchModel(t,e,s){if("activateTab"===e){const e=s.targetModel;this._model.getState().tabs.forEach((t=>{const s=t._model,a=s.getState().actived;e===s?t._view.activate():a&&s.deactivate(new d(!1))})),t.stopPropagation()}else if("deleteTab"===e){s.tab._view.remove()}else"setPanelPosition"===e?(this._view.setPosition(s),t.stopPropagation()):"toggleTabSplitEvent"===e?this._view.setTabSplitEvent(s):"setZIndex"===e?this._view.setZIndex(s):"addTabs"===e&&this._view.addTabs(s)}dispatchView(t,e,s){"panelDragStart"===e?E.value.panel=s:"insertPanelToTabHeader"===e&&(this._parent.host.deletePanel(E.value.panel),s.state.tabs.forEach((t=>t._view.create())),E.reset(),Reflect.apply(this._model.addTabs,this._model,s.state.tabs))}getModel(){return this._model}}class P extends v{constructor(t,e){super(),this._state={id:o("panel"),position:{left:0,top:0},zIndex:0,actived:!1,tabs:[],_tabSplitEnabled:!0},a(this._state,t),this.host=e}setZIndex(t){this._state.zIndex=t,this.notify(new d(!1),"setZIndex",t)}setPosition(t){a(this._state.position,t),this.notify(new d(!1),"setPanelPosition",this._state.position)}activate(){this._state.actived=!0,this.notify(new d,"activatePanel",this.host)}deactivate(){this._state.actived=!1,this.notify(new d,"deactivatePanel")}deleteTab(e){t.pull(this._state.tabs,e),this.notify(new d,"deleteTab",{tab:e})}addTabs(...t){this._state.tabs=this._state.tabs.concat(t),this.notify(new d(!1),"addTabs",t)}toggleTabSplitEvent(t){this._state._tabSplitEnabled=i(t)?t:!this._state._tabSplitEnabled,this.notify(new d(!1),"toggleTabSplitEvent",this._state._tabSplitEnabled)}getState(){return this._state}}class y extends h{constructor(t){super("View",t)}}class A extends w{constructor(t){super(),this.events={},this.host=t}addTabs(t){t.forEach((t=>{const{btn:e,content:s}=t._view.getElements();this._$header.append(e),this._$wrapper.append(s)}))}setZIndex(t){this._$wrapper.css("z-index",t)}setTabSplitEvent(t){this._model.getState().tabs.forEach((e=>{e._view.toggleTabSplitEvent(t),this.toggleDragPanelWithTabEvent(e,!t)}))}toggleDragPanelWithTabEvent(t,e){t._model.toggleTabHandleEvent(e)}setPosition(t){this.events.panelDrag=this._$wrapper.css({left:t.left+"px",top:t.top+"px"})}create(){const t=this._model.getState().tabs;this._createElements(),this._$wrapper.append(this._$panelHandle).append(this._$header),t.forEach((t=>{const{btn:e,content:s}=t._view.getElements();this._$wrapper.append(s),this._$header.append(e)})),this.bindEvents()}bindEvents(){this._$wrapper.on("mousedown",(()=>{this._model.activate()})),this._$wrapper.draggable({handle:"."+g.PANE_HANDLE,start:()=>{this.notify(new y(!1),"panelDragStart",this.host)}}),this._$header.droppable({tolerance:"pointer",drop:()=>{this.notify(new y,"insertPanelToTabHeader",this.host)}})}_createElements(){this._$wrapper=r(g.PANE),this._$panelHandle=r(g.PANE_HANDLE),this._$header=r(g.TAB_HEADER)}getElements(){return{wrapper:this._$wrapper,handle:this._$panelHandle,header:this._$header}}}class S{constructor(t){this._model=new P(t,this),this._view=new A(this),this._controller=new m(this._model,this._view,this),this._init()}get state(){return this._model.getState()}setZIndex(t){this._model.setZIndex(t)}setPosition(t){this._model.setPosition(t)}_init(){const t=this._model.getState();this._view.create(),t.tabs.forEach((t=>t._controller.setParent(this._controller))),this.refreshTabSplitEvent()}refreshTabSplitEvent(){const t=this._model.getState();t.tabs.length<=1&&t._tabSplitEnabled?this._model.toggleTabSplitEvent(!1):t.tabs.length>1&&!t._tabSplitEnabled&&this._model.toggleTabSplitEvent(!0)}deleteTab(t){this._model.deleteTab(t)}static copyPanelByTabs(...t){const e=t.map((t=>{const e=f.copy(t);return e._model.activate(new d(!1)),e}));return new S({tabs:e})}}class x{constructor(){this._panelMap=l(null),this._panelCount=0,this._topZIndex=0}add(t){const e=t.state.id;this._panelMap[e]=t,this._topZIndex=this._panelCount++,t.setZIndex(this._panelCount-1)}remove(t){var e=this._panelMap[t];e&&(this._topZIndex===e.state.zIndex&&this._topZIndex--,delete this._panelMap[t],this._panelCount--)}activate(t){if(t.state.zIndex!==this._topZIndex){for(var e in this._panelMap){var s=this._panelMap[e];s.state.zIndex>t.state.zIndex&&s.setZIndex(s.state.zIndex-1)}t.setZIndex(this._topZIndex)}}}class N extends p{constructor(t,e,s){super(t,e),this.host=s}dispatchModel(t,e,s){"addPanel"===e?(this.host.panelLayer.add(s),s._controller.setParent(this),this._view.addPanel(s)):"deletePanel"===e?(this.host.panelLayer.remove(s),this._view.deletePanel(s)):"activatePanel"===e&&this.host.panelLayer.activate(s)}dispatchView(t,e){}}class I extends v{constructor(t){super(),this._state={panels:[],groups:[],stage:"body"},a(this._state,t)}getState(){return this._state}addPanel(t){this._state.panels.push(t),this.notify(new d(!1),"addPanel",t)}deletePanel(t){!function(...t){s.default.pull.apply(null,t)}(this._state.panels,t),this.notify(new d(!1),"deletePanel",t)}}class B extends w{create(t){this._$wrapper=$(t.stage).addClass(g.STAGE),t.panels.forEach((t=>this.addPanel(t))),this.bindEvents()}addPanel(t){this._$wrapper.append(t._view.getElements().wrapper)}deletePanel(t){t._view.getElements().wrapper.remove()}bindEvents(){this._$wrapper.droppable({drop:(t,e)=>{"tmpPanelFromTabDrag"===E.value.type&&(E.value.tab.getParent().deleteTab(E.value.tab),E.value.panel._view.create(),E.value.panel.setPosition(e.offset),E.value.tab._controller.getParent().host.refreshTabSplitEvent(),this._model.addPanel(E.value.panel),E.reset())}})}}class C{constructor(t){this.panelLayer=new x,this._model=new I(t),this._view=new B,this._controller=new N(this._model,this._view,this),this._init()}addPanel(t){this._model.addPanel(t)}deletePanel(t){this._model.deletePanel(t)}_init(){const t=this._model.getState();this._view.create(t),t.panels.forEach((t=>{t._controller.setParent(this._controller),this.panelLayer.add(t)}))}}
/**
   * A library for creating panels like PhotoShop.
   * 
   * Support ES5 browsers and above (ie10+, edge12+, chrome23+, safari6+, opeara15+)
   * For more compatibility details, see https://www.caniuse.com/es5
   * 
   * @author cary-mao
   * @license MIT
   * @copyright cary-mao 2021
   * @email 773099867@qq.com
   */
const H=function(t){const e={stage:(t=function(t={}){return a({panels:[],groups:[],stage:"body"},t)}(t)).stage};e.panels=t.panels.map((t=>{const e=n(t);if(t.tabs){const s=t.tabs.filter((t=>t.actived));if(s.length)for(let t=1,e=s.length;t<e;t++)s[t].actived=!1;e.tabs=t.tabs.map((t=>new f(t)))}return new S(e)}));return new C(e)};return H.Panel=S,H.PanelStage=C,H.PanelGroup=class{},H}));
