var comtab=function(a){if(!a)throw new Error("[comtab]: comtab.js require jquery.js");if(!a.ui)throw new Error("[comtab]: comTab.js require jquery-ui.js");var t,e,s=function(t){var e,n=t+"-pane",t=t+"-tab",a=h({PANE:n,PANE_HANDLE:n+"_handle",TAB:t,TAB_HEADER:t+"_header",TAB_CONTENT:t+"_content",TAB_BTN:t+"_btn"});for(e in a)a[e+"_ACTIVE"]=a[e]+"-active";return a}("comtab"),i="body",o=a(i),r=null;function p(t,e){this.tabs=t,this._normalizeOptions(e),this._init(),this._options.autoMount&&this.mount(),(this._options.width||this._options.height)&&this.setSize(this._options.width,this._options.height)}function d(t,e,n){n=n||{};var a=l(),i=!!n.actived,o=n.tag;return e.addClass(s.TAB_CONTENT).data("tab-id",a),t.addClass(s.TAB_BTN).data("tab-id",a),i&&(t.addClass(s.TAB_BTN_ACTIVE),e.addClass(s.TAB_CONTENT_ACTIVE)),h({id:a,btn:t,content:e,_options:n,tag:o,actived:i})}function c(t,e){return new p(t,e)}function _(t){o=a(i=t)}function h(t){var e={};if(t)for(var n in t)t.hasOwnProperty&&!t.hasOwnProperty(n)||(e[n]={value:t[n],writable:!0,configurable:!0,enumerable:!0});return Object.create(null,e)}function u(t,e){return t>=e[0]&&t<=e[1]}o.droppable({addClasses:!1,drop:function(t,e){r.type===s.TAB_BTN&&(f(),setTimeout(function(){p.createPaneByDomMap(r.pane._tplPaneMap,[r.tab._tpl]).setPosition(e.offset).mount(),r.tab._tpl.btn.data("tab-id",r.tab._tpl.id),r.tab._tpl.content.data("tab-id",r.tab._tpl.id)}))}}),p.prototype={mount:function(){return o.append(this._pane),this},removeTab:function(t){this.tabs.splice(this.tabs.indexOf(t),1),t.content.remove(),t.btn.remove()},addTab:function(t){this.tabs.push(t),this._tabHeader.append(t.btn),this._pane.append(t.content)},setPosition:function(t){return this._pane.css({position:"absolute",left:t.left+"px",top:t.top+"px"}),this},setRestrictSize:function(n){var a=this;["minWidth","minHeight","maxWidth","maxHeight"].forEach(function(t){var e="_"+t;a._resizable.resizable("option",t,a[e]=n[t]||a[e])})},setSize:function(t,e){return this._pane.css({width:t,height:e}),this},refreshZIndexCSS:function(){this._pane.css("z-index",this.zIndex)},toJSON:function(){var t=this._pane.position(),e=this._pane.width(),n=this._pane.height(),a=this.tabs.map(function(t){var e=h(t._options);return e.actived=t.actived,e}),i=h(this._options);return delete i.autoMount,i.width=e,i.height=n,{position:t,options:i,tabs:a}},_init:function(){var e=this,t=this._createPaneDomMap(),n=null;this._pane=t.pane,this._paneHandle=t.paneHandle,this._tabHeader=t.tabHeader,this.tabs.forEach(function(t){e._appendTab(t),e._initTabEvent(t),n&&t.actived?e._deactiveTab(t):t.actived&&e._activeTab(n=t)}),this.tabs.length<2&&this.tabs[0]._draggable.draggable("disable"),n||this._activeTab(n=this.tabs[0]),this._initPaneEvent(),this._initRestrictSize(),this._mapDom(),this.refreshZIndexCSS()},_activeTab:function(t){t.actived=!0,t.btn.addClass(s.TAB_BTN_ACTIVE),t.content.addClass(s.TAB_CONTENT_ACTIVE)},_deactiveTab:function(t){t.actived=!1,t.btn.removeClass(s.TAB_BTN_ACTIVE),t.content.removeClass(s.TAB_CONTENT_ACTIVE)},_initRestrictSize:function(){this.setRestrictSize(this._options)},_mapDom:function(){this._pane.data("pane-id",this.id=b.addPane(this))},_concatPane:function(t){var e=this;b.removePane(t.id),this.tabs.forEach(function(t){t.actived&&e._deactiveTab(t)}),this.tabs.length<2&&this.tabs[0]._draggable.draggable("enable"),t.tabs.forEach(function(t){e.addTab(t),t._draggable.draggable("destroy"),e._initTabEvent(t)}),t._pane.remove()},_initTabEvent:function(t){var e=this;t._draggable=t.btn.draggable({appendTo:o,addClasses:!1,helper:function(){return t._tpl=e._cloneTab(t),e._tplPaneMap=e._clonePaneDomMap(t._tpl),e._activeTab(t._tpl),r=h({pane:e,tab:t,type:s.TAB_BTN}),e._tplPaneMap.pane},drag:function(t){v(t)}})},_initPaneEvent:function(){var n=this;this._draggable=this._pane.draggable({appendTo:o,handle:this._paneHandle,addClasses:!1,start:function(){r=h({type:s.PANE,pane:n})},drag:function(t){v(t)}}),this._resizable=this._pane.resizable({addClasses:!1,containment:o,handles:"n, e, s, w, ne, se, sw, nw"}),this._droppable=this._pane.droppable({greedy:!0,addClasses:!1,tolerance:"pointer",over:function(){r.overedPane=n},out:function(){r.overedPane=null,T(n)},drop:function(){var t;T(n),r.type===s.PANE?n._concatPane(r.pane):r.type===s.TAB_BTN&&r.pane!==n&&(t=p.createPaneByDomMap(r.pane._tplPaneMap,[r.tab._tpl]),n._concatPane(t),f())}}),this._listeners={paneSelect:function(t){b.selectPane(n);var e=a(t.target).data("tab-id");!e||(t=n.tabs.filter(function(t){return t.id===e})[0])&&!t.actived&&(n.tabs.forEach(function(t){t.actived&&n._deactiveTab(t)}),n._activeTab(t))}},this._pane.on("mousedown",this._listeners.paneSelect)},_clonePaneDomMap:function(t){var e=this._createPaneDomMap();return this._appendTab.call({_pane:e.pane,_paneHandle:e.paneHandle,_tabHeader:e.tabHeader},t),e},_cloneTab:function(t){return d(t.btn.clone(),t.content.clone(),t._options)},_appendTab:function(t){this._pane.append(t.content),this._tabHeader.append(t.btn)},_normalizeOptions:function(t){t=t||{},this._options=t;var e=h({autoMount:!1,minWidth:100,minHeight:60});this._options=Object.assign(e,t)},_createPaneDomMap:function(){var t=a('<div class="'+s.PANE+'"></div>'),e=a('<div class="'+s.PANE_HANDLE+'"></div>'),n=a('<div class="'+s.TAB_HEADER+'"></div>');return t.append(e).append(n),h({pane:t,paneHandle:e,tabHeader:n})}},p.createPaneByDomMap=function(t,e){var n=new p._Fn;return n._createPaneDomMap=function(){return t},p.call(n,e),delete n._createPaneDomMap,n},p.parseJSON=function(t,n,e){return t.options.autoMount=void 0===e||e,c(t.tabs.map(function(t){var e=n[t.tag];return d(e.btn,e.content,t)}),t.options).setPosition(t.position)},t=p._Fn=function(){},e=p,e=Object.create(e.prototype),(t.prototype=e).constructor=t,p._Fn.prototype=p.prototype;var b={paneMap:h(null),paneCount:0,topZIndex:0,addPane:function(t){var e=l();return this.paneMap[e]=t,this.topZIndex=t.zIndex=this.paneCount++,e},removePane:function(t){this.topZIndex===this.paneMap[t].zIndex&&this.topZIndex--,delete this.paneMap[t],this.paneCount--},selectPane:function(t){if(t.zIndex!==this.topZIndex){for(var e in this.paneMap){var n=this.paneMap[e];n.zIndex>t.zIndex&&(n.zIndex--,n.refreshZIndexCSS())}t.zIndex=this.topZIndex,t.refreshZIndexCSS()}}};function l(){var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=[];for(32,t=0;t<32;t++)n[t]=e[0|16*Math.random()];return n.join("")}function f(){r.pane.removeTab(r.tab),r.pane.tabs.length<2&&r.pane.tabs[0]._draggable.draggable("disable"),r.tab.actived&&r.pane._activeTab(r.pane.tabs[0])}function v(t){var e,n=r.overedPane;n&&(e=n._tabHeader,t={x:t.pageX,y:t.pageY},n=n._pane.offset(),t.x-=n.left,t.y-=n.top,n=t,(t=e.position()).width=e.outerWidth(),t.height=e.outerHeight(),t=t,n=u((n=n).x,[t.left,t.left+t.width])&&u(n.y,[t.top,t.top+t.height]),t=r.inOveredTabHeader^n,r.inOveredTabHeader=n,t&&(n?e.addClass(s.TAB_HEADER_ACTIVE):e.removeClass(s.TAB_HEADER_ACTIVE)))}function T(t){r.inOveredTabHeader&&(t._tabHeader.removeClass(s.TAB_HEADER_ACTIVE),r.inOveredTabHeader=!1)}return{createPane:c,createTab:d,setStageBySelector:_,Pane:p,parseJSON:function(t,e,n){return o!==i&&_(t.stage),t.panes.map(function(t){return p.parseJSON(t,e,n)})},toJSON:function(){var t,e=[];for(t in b.paneMap){var n=b.paneMap[t];e.push(n.toJSON())}return{stage:i,panes:e}}}}(window.$||window.jQurey);